{% if user_bookings %}
    <div>
        <h1>Your Bookings</h1>
        <div>
            {% for booking in user_bookings %}
                <div class="booking-item" data-booking-id="{{ booking.id }}">
                    <h2>{{ booking.time_slot.bookable_item.name }}</h2>
                    <p>Time: {{ booking.time_slot.time_start }}</p>
                    <p>Length: {{ booking.time_slot.time_length }}</p>
                    {% if booking.notes %}<p>Notes: {{ booking.notes }}</p>{% endif %}
                    <button data-booking-id="{{ booking.id }}"
                            onclick="deleteBooking(this, {{ booking.id }})"
                            style="background-color: #dc3545;
                                   color: white;
                                   border: none;
                                   padding: 8px 16px;
                                   border-radius: 4px;
                                   cursor: pointer">Cancel Booking</button>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}
<script>
function deleteBooking(button, bookingId) {
    if (confirm('Are you sure you want to cancel this booking?')) {
        button.disabled = true;
        button.textContent = 'Cancelling...';
        fetch('/bookings/user-bookings/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId
            })
        })
        .then(async response => {
            let data;
            try {
                data = await response.json();
            } catch (e) {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                alert('Error: Server did not return JSON. You may not be logged in or there was a server error.');
                button.disabled = false;
                button.textContent = 'Cancel Booking';
                return;
            }
            if (data.success) {
                document.dispatchEvent(new CustomEvent('booking-cancelled'));
            } else {
                alert('Error: ' + data.error);
                button.disabled = false;
                button.textContent = 'Cancel Booking';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while cancelling the booking.');
            button.disabled = false;
            button.textContent = 'Cancel Booking';
        });
    }
}
</script>
