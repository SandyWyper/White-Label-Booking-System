{% if user_bookings %}
    <div>
        <h2>Your Bookings</h2>
        <div class="flex gap-6 md:flex-row flex-wrap">
            {% for booking in user_bookings %}
                <div class="card bg-base-200 text-base-content border border-base-300 shadow-md mb-6 min-w-64">
                    <div class="card-body">
                        <h2 class="card-title">{{ booking.time_slot.bookable_item.name }}</h2>
                        <p>
                            <span class="font-semibold">Time:</span> {{ booking.time_slot.time_start }}
                        </p>
                        <p>
                            <span class="font-semibold">Length:</span> {{ booking.time_slot.time_length }}
                        </p>
                        {% if booking.notes %}
                            <p>
                                <span class="font-semibold">Notes:</span> {{ booking.notes }}
                            </p>
                        {% endif %}
                        <div class="card-actions justify-end">
                            <button class="btn btn-error btn-sm btn-outline"
                                    data-booking-id="{{ booking.id }}"
                                    onclick="deleteBooking(this, {{ booking.id }})">Cancel Booking</button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}
<script>
function deleteBooking(button, bookingId) {
    if (confirm('Are you sure you want to cancel this booking?')) {
        button.disabled = true;
        button.textContent = 'Cancelling...';
        fetch('/user-bookings/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId
            })
        })
        .then(async response => {
            let data;
            try {
                data = await response.json();
            } catch (e) {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                alert('Error: Server did not return JSON. You may not be logged in or there was a server error.');
                button.disabled = false;
                button.textContent = 'Cancel Booking';
                return;
            }
            if (data.success) {
                document.dispatchEvent(new CustomEvent('booking-cancelled'));
            } else {
                alert('Error: ' + data.error);
                button.disabled = false;
                button.textContent = 'Cancel Booking';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while cancelling the booking.');
            button.disabled = false;
            button.textContent = 'Cancel Booking';
        });
    }
}
</script>
